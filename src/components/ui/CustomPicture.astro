---
import { getImage } from "astro:assets";

interface Props {
  desktop: ImageMetadata | string;
  tablet?: ImageMetadata | string;
  mobile: ImageMetadata | string;
  fallbackWidth: number;
  fallbackHeight: number;
  priority: boolean;
  alt: string;
  widths?: number[];
  sizes?: string;
  class?: string;
}

const customWidths = [320, 480, 640, 768, 1024, 1280, 1536, 1920, 2560];

const {
  mobile,
  tablet,
  desktop,
  fallbackWidth,
  fallbackHeight,
  priority = false,
  alt,
  widths = customWidths,
  sizes: globalSizes,
  class: className,
  ...rest
} = Astro.props;

// const baseOptions = {
//   priority,
//   layout,
//   widths,
//   quality: 80,
// };

const desktopSizes = globalSizes || "(min-width: 64rem) 100vw, 1200px";
const tabletSizes = globalSizes || "(min-width: 40rem) 100vw, 768px";
const mobileSizes = globalSizes || "100vw";

const desktopAvif = await getImage({
  src: desktop,
  priority: priority,
  format: "avif",
  widths: customWidths,
  sizes: desktopSizes,
});
const desktopWebp = await getImage({
  src: desktop,
  priority: priority,
  format: "webp",
  widths: customWidths,
  sizes: desktopSizes,
});
const desktopJpg = await getImage({
  src: desktop,
  priority: priority,
  format: "jpg",
  widths: customWidths,
  sizes: desktopSizes,
});

let tabletAvif;
let tabletWebp;
let tabletJpg;
if (tablet) {
  tabletAvif = await getImage({
    src: tablet,
    priority: priority,
    format: "avif",
    widths: customWidths,
    sizes: desktopSizes,
  });
  tabletWebp = await getImage({
    src: tablet,
    priority: priority,
    format: "webp",
    widths: customWidths,
    sizes: desktopSizes,
  });
  tabletJpg = await getImage({
    src: tablet,
    priority: priority,
    format: "jpg",
    widths: customWidths,
    sizes: desktopSizes,
  });
}

const mobileAvif = await getImage({
  src: mobile,
  priority: priority,
  format: "avif",
  widths: customWidths,
  sizes: mobileSizes,
});
const mobileWebp = await getImage({
  src: mobile,
  priority: priority,
  format: "webp",
  widths: customWidths,
  sizes: mobileSizes,
});
const mobileJpg = await getImage({
  src: mobile,
  priority: priority,
  format: "jpg",
  widths: customWidths,
  sizes: mobileSizes,
  width: fallbackWidth,
  height: fallbackHeight,
});
---

<picture class={className} {...rest}>
  <!-- Desktop -->
  <source
    media="(min-width: 40rem)"
    srcset={desktopAvif.srcSet.attribute}
    sizes={desktopAvif.attributes.sizes}
    type="image/avif"
  />
  <source
    media="(min-width: 40rem)"
    srcset={desktopWebp.srcSet.attribute}
    sizes={desktopWebp.attributes.sizes}
    type="image/webp"
  />
  <source
    media="(min-width: 40rem)"
    srcset={desktopJpg.srcSet.attribute}
    sizes={desktopJpg.attributes.sizes}
    type="image/jpeg"
  />
  <!-- Tablet -->

  {tabletAvif && <source media="(min-width: 40rem)" srcset={tabletAvif.src} type="image/avif" />}
  {tabletWebp && <source media="(min-width: 40rem)" srcset={tabletWebp.src} type="image/webp" />}
  {tabletJpg && <source media="(min-width: 40rem)" srcset={tabletJpg.src} type="image/jpg" />}
  <!-- Mobile -->
  <source
    media="(max-width: 40rem)"
    srcset={mobileAvif.srcSet.attribute}
    sizes={mobileAvif.attributes.sizes}
    type="image/avif"
  />
  <source
    media="(max-width: 40rem)"
    srcset={mobileWebp.srcSet.attribute}
    sizes={mobileWebp.attributes.sizes}
    type="image/webp"
  />
  <img
    src={mobileJpg.src}
    srcset={mobileJpg.srcSet?.attribute}
    sizes={mobileJpg.attributes.sizes || "100vw"}
    alt={alt}
    width={mobileJpg.attributes.width}
    height={mobileJpg.attributes.height}
    loading={priority ? "eager" : "lazy"}
    decoding={priority ? "sync" : "async"}
    fetchpriority={priority ? "high" : "auto"}
  />
</picture>

<style>
  .cyber-grid img {
    height: 100%;
    width: 100%;
  }
</style>
