---
// Data
const sectionTitle = "Testimonials";
const sectionSubtitle = "Client wins coming soon";
const sectionText =
  "My Melbourne web design studio is gearing up, so testimonials are pending as client collaborations begin. This section will soon showcase video feedback from our partners who've boosted their bookings, visibility and revenue through our tailored sites, providing real success stories.";
const sectionTitleId = "testimonials";

// Images
import TestimonialBGLeft from "@/assets/icons/cyber-bg/testimonial-bg-left.svg";
import TestimonialBGRight from "@/assets/icons/cyber-bg/testimonial-bg-right.svg";

import TestimonialImg1 from "@/assets/images/desktop/testimonial-1.png";
import TestimonialImg2 from "@/assets/images/desktop/testimonial-2.png";
import TestimonialImg3 from "@/assets/images/desktop/testimonial-3.png";

// Icons
import ChevLeftSvg from "@/assets/icons/chev-left.svg";
import ChevRightSvg from "@/assets/icons/chev-right.svg";
import PlaySvg from "@/assets/icons/play.svg";
import PauseSvg from "@/assets/icons/pause.svg";

// Components
import Picture from "astro/components/Picture.astro";
import SectionHeader from "../ui/SectionHeader.astro";
---

<section class="testimonials | grid-main" aria-labelledby={sectionTitleId}>
  <SectionHeader
    title={sectionTitle}
    subtitle={sectionSubtitle}
    supportingText={sectionText}
    titleTag="h2"
    titleId={sectionTitleId}
    class="testimonials__header"
  />

  <div class="carousel carousel--testimonials">
    <div class="carousel__btn-wrapper">
      <button class="carousel__btn prev" data-carousel-btn="prev">
        <ChevLeftSvg aria-hidden="true" class="carousel__btn-svg" />
      </button>
      <button class="carousel__btn next" data-carousel-btn="next">
        <ChevRightSvg aria-hidden="true" class="carousel__btn-svg" />
      </button>
    </div>

    <ul class="carousel__list">
      <li class="carousel__card-wrapper">
        <div class="carousel__card">
          <div class="picture__wrapper">
            <Picture
              src={TestimonialImg1}
              formats={["avif", "webp"]}
              fallbackFormat="jpg"
              alt=""
              layout="constrained"
              widths={[320, 480, 640, 800]}
              priority={false}
              class="testimonial__img"
              pictureAttributes={{ class: "testimonial__picture" }}
            />
          </div>
          <TestimonialBGLeft class="cyber-grid left" />
          <TestimonialBGRight class="cyber-grid right" />
        </div>
      </li>
      <li class="carousel__card-wrapper">
        <div class="carousel__card">
          <div class="picture__wrapper">
            <Picture
              src={TestimonialImg2}
              formats={["avif", "webp"]}
              fallbackFormat="jpg"
              alt=""
              layout="constrained"
              widths={[320, 480, 640, 800, 1020, 1280, 1400, 1800]}
              priority={false}
              class="testimonial__img"
              pictureAttributes={{ class: "testimonial__picture" }}
            />
          </div>
          <TestimonialBGLeft class="cyber-grid left" />
          <TestimonialBGRight class="cyber-grid right" />
        </div>
      </li>
      <li class="carousel__card-wrapper">
        <div class="carousel__card">
          <div class="picture__wrapper">
            <Picture
              src={TestimonialImg3}
              formats={["avif", "webp"]}
              fallbackFormat="jpg"
              alt=""
              layout="constrained"
              widths={[320, 480, 640, 800, 1020, 1280, 1400, 1800]}
              priority={false}
              class="testimonial__img"
              pictureAttributes={{ class: "testimonial__picture" }}
            />
          </div>
          <TestimonialBGLeft class="cyber-grid left" />
          <TestimonialBGRight class="cyber-grid right" />
        </div>
      </li>
    </ul>

    <div class="carousel__indicators-wrapper">
      <button class="carousel__indicator" aria-label="" data-indicator-active="true"></button>
      <button class="carousel__indicator" aria-label=""></button>
      <button class="carousel__indicator" aria-label=""></button>
    </div>
    <div class="video__control-btns">
      <button class="video__control-btn play" data-play>
        <PlaySvg aria-hidden="true" class="video__btn-svg" width="64" height="64" />
      </button>
      <button class="video__control-btn pause" data-pause>
        <PauseSvg aria-hidden="true" class="video__btn-svg" width="64" height="64" />
      </button>
    </div>
  </div>
</section>

<style>
  .testimonials {
    margin-block-end: calc(var(--section-space) * 1.5);
  }

  .carousel {
    position: relative;
    margin-block-start: var(--spacing-xl);
  }

  .carousel__list {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: 100%;
    gap: 25px;
    overflow-x: hidden;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    scrollbar-width: none;

    /* prettier-ignore */
    filter: 
    drop-shadow(0 0 2px hsl(from var(--cyber-cyan-500) h s l / 0.75))
    drop-shadow(0 0 12px hsl(from var(--cyber-cyan-500) h s l / 0.15));
  }

  .carousel__card {
    position: relative;
    /* z-index: 100; */
    display: flex;
    min-height: 300px;
    background-color: var(--cyber-void-400);
    border: 1px solid var(--cyber-void-100);

    clip-path: polygon(
      0 0,
      calc(100% - 20px) 0,
      100% 20px,
      100% 100%,
      20px 100%,
      0 calc(100% - 20px)
    );
  }

  .carousel__card::before,
  .carousel__card::after {
    content: "";
    z-index: 500;
    position: absolute;
    width: 30px;
    height: 30px;
    border: 2px solid var(--cyber-cyan-500);
    pointer-events: none;
  }

  .carousel__card::before {
    top: -1px;
    left: -1px;
    border-right: none;
    border-bottom: none;
  }

  .carousel__card::after {
    right: -1px;
    bottom: -1px;
    border-top: none;
    border-left: none;
  }

  .testimonial__picture {
    width: 100%;
    height: 100%;
  }

  .testimonial__img {
    opacity: 0.1;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .carousel__btn {
    position: absolute;
    z-index: 100;
    top: 50%;
    transform: translateY(calc(-50%) - 40px);
    background-color: transparent;
    border: 0px;
    cursor: pointer;
  }

  .carousel__btn.prev {
    left: 5px;
  }
  .carousel__btn.next {
    right: 5px;
  }

  .carousel__btn-svg {
    color: var(--cyber-cyan-500);
    filter: drop-shadow(0 0 8px var(--cyber-cyan-500));
    width: 48px;
    height: 48px;

    transition: 100ms ease-in-out;
    transition-property: filter, scale;
  }

  .video__control-btn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translateX(-50%);

    background-color: transparent;
    border: 0px;
    cursor: pointer;
  }

  .video__btn-svg {
    color: var(--cyber-cyan-500);
    filter: drop-shadow(0 0 8px var(--cyber-cyan-500));
    width: 64px;
    height: 64px;
  }

  .video__control-btn.pause {
    display: none;
  }

  .carousel__indicators-wrapper {
    position: absolute;
    top: 100%;
    right: 50%;
    transform: translateX(50%);
    display: flex;
    gap: 16px;
    margin-block-start: 30px;
  }

  .carousel__indicator {
    width: 10px;
    height: 10px;
    border: none;
    border-radius: 100%;
    background-color: #ccc;
    cursor: pointer;
  }

  .carousel__indicator[data-indicator-active] {
    background-color: var(--cyber-cyan-500);
    filter: drop-shadow(0 0 8px var(--cyber-cyan-500));
  }

  .cyber-grid {
    position: absolute;
    z-index: -1;
    top: 0;
    bottom: 0;
    height: 100%;
    width: 125px;
    filter: blur(2px);
  }

  .cyber-grid.left {
    left: 0;
  }

  .cyber-grid.right {
    right: 0;
  }

  /* Hover/Focus */
  .carousel__btn:hover .carousel__btn-svg {
    filter: drop-shadow(0 0 10px var(--cyber-cyan-500)) brightness(1.5);
    scale: 1.2;
  }

  @media (min-width: 40rem) {
    .cyber-grid {
      width: auto;
    }

    .testimonials__header {
      p {
        max-width: 75ch;
        margin-inline: auto;
      }
    }
  }

  @media (min-width: 62.5rem) {
    .testimonials__header {
      p {
        margin-block-start: var(--spacing-lg);
      }
    }
  }
</style>

<script>
  const carousel = document.querySelector(`.carousel`);
  const carouselBtns = carousel?.querySelectorAll<HTMLButtonElement>(`.carousel__btn`);
  const carouselIndicatorBtns =
    carousel?.querySelectorAll<HTMLButtonElement>(`.carousel__indicator`);
  let isInitialLoad = true;

  function goToSlide(newIndex: any) {
    const slides = carousel!.querySelectorAll<HTMLElement>(`.carousel__card`);
    const indicators = carousel!.querySelectorAll<HTMLButtonElement>(`.carousel__indicator`);

    const currentSlide = carousel?.querySelector<HTMLElement>(`.carousel__card[data-active]`);
    const currentIndicator = carousel?.querySelector<HTMLElement>(
      `.carousel__indicator[data-indicator-active]`,
    );

    if (currentSlide) delete currentSlide.dataset.active;
    if (currentIndicator) delete currentIndicator.dataset.indicatorActive;

    const targetIndex = (newIndex + slides.length) % slides.length;

    slides[targetIndex].dataset.active = `true`;
    indicators[targetIndex].dataset.indicatorActive = `true`;

    if (!isInitialLoad) {
      slides[targetIndex].scrollIntoView({
        behavior: "smooth",
        inline: "start",
        block: "nearest",
      });
    }
    isInitialLoad = false;
  }

  carouselBtns!.forEach((btn) => {
    btn.addEventListener(`click`, (e) => {
      const activeSlide = carousel!.querySelector<HTMLElement>(`.carousel__card[data-active]`);

      if (!activeSlide) return;

      const slides = carousel!.querySelectorAll<HTMLElement>(`.carousel__card`);
      const currentIndex = [...slides].indexOf(activeSlide);

      const offset = btn.dataset.carouselBtn === "next" ? 1 : -1;
      goToSlide(currentIndex + offset);
    });
  });

  carouselIndicatorBtns?.forEach((btn, i) => {
    btn.addEventListener(`click`, () => {
      goToSlide(i);
    });
  });

  goToSlide(0);
</script>
